<!-- 
Copyright 2023 Dirk Luberth Dijkman Bangert 30 1619GJ Andijk The Netherlands    
The Art of Time Controlled. Visual TimeSlots Schedule.
-->
<html
    lang="en"
>
    <head>
        <meta charset="UTF-8" />
        <title>Telegram WebApp MiniApp Arduino ESP8266, The Art of Time Controlled. Visual TimeSlots Schedule. On/Off Switch Times</title>
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://telegram.org/js/telegram-web-app.js"></script>

      
      <!-- Link Swiper's CSS -->
  <script>
        window.onload = function() {
            // Check if Telegram Web Apps is available
            if (window.Telegram.WebApp) {
                const telegramWebApp = window.Telegram.WebApp;

                // Get user information
                const user = telegramWebApp.initDataUnsafe.user;

                // Display user ID and name
                document.getElementById('userId').innerText = `User ID: ${user.id}`;
                document.getElementById('userName').innerText = `User Name: ${user.first_name} ${user.last_name ? user.last_name : ''}`;
                document.getElementById('userUsername').innerText = `Username: ${user.username ? user.username : 'N/A'}`;
                document.getElementById('userLanguage').innerText = `Language: ${telegramWebApp.initDataUnsafe.language_code}`;

                // Profile photo (assuming URL is given, replace with actual photo URL fetching if available)
                const profilePic = user.photo_url ? user.photo_url : 'https://via.placeholder.com/100';
                document.getElementById('profilePic').src = profilePic;

                // Send data back to Telegram
                document.getElementById('sendDataButton').onclick = function() {
                    telegramWebApp.sendData(`Hello, ${user.first_name}! Your ID is ${user.id}`);
                };

            } else {
                alert('Telegram Web Apps is not available');
            }
        };
    </script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"/>

        <style>
            body {
                font-family: Arial, sans-serif;
            }
            #time-status,
            #current-time {
                margin-top: 20px;
            }
            .time-input {
                width: 50px;
                margin-right: 5px;
            }
            .time-entry {
                margin-bottom: 5px;
            }
            .time-entry label {
                display: inline-block;
                width: 30px;
            }
            .status-on {
                color: green;
            }
            .status-off {
                color: red;
            }
            #time-bar-container {
                position: absolute;
                left: 0;
                width: 100%;
                height: 50px;
                background-color: #c8c2c2;

                margin: 5px;
                margin-top: 15px;
                position: absolute;
                z-index: 1000;
                border: 1px solid gray;
                padding: 5px;
            }
            #time-bar {
                height: 100%;
                position: absolute;
                left: 0;
                top: 5px;
                width: 100%;
                height: 50px;
                background-color: #dad6d6;

                position: absolute;
                z-index: 1000;
            }
            .time-segment {
                height: 100%;
                position: absolute;
                background-color: greenyellow;
            }
            
            .time-picker-header {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 180px; /* Adjust based on your needs */
}

/*
ask Ai
create a vertical line at bottom start and end of each time-segment 
*/
.time-segment::before,
.time-segment::after {
    content: '';
    position: absolute;
    top: 0;
    width: 1px; /* Adjust the width of the line as needed */
    height: 60px; /* Adjust the height of the line as needed */
    background-color: #000; /* Adjust the color of the line as needed */
    pointer-events: none;
}

.time-segment::before {
    background-color: green; /* Adjust the color of the line as needed */
    left: 0;
}

.time-segment::after {
    background-color: red; /* Adjust the color of the line as needed */
    height: 70px;
    right: 0;
}
/*
Ask Ai
place a label below the .time-segment::before and after line, with the corresponding time
*/
.time-label {
    position: absolute;
    bottom: -20px; /* Adjust as needed */
    font-size: 10px; /* Adjust as needed */
    color: #000; /* Adjust as needed */
    white-space: nowrap;
    pointer-events: none;
}

.start-label {
    color:green;
    transform: translateX(-50%);
}

.end-label {
    color:red;
    bottom: -35px;
    transform: translateX(-50%);
}
            #time-scale-container {
                width: 100%;
                left: 0;
                height: 50px;
                position: absolute;
                margin: 5px;
                padding: 5px;
            }

            .scale-marker {
                position: absolute;
                left: 0;
                height: 100%;
                width: 1px;
                background-color: #333;
            }

            .scale-label {
                position: absolute;
                margin-left: -5px; /* Adjust as needed */
                margin-top: -15px;
                font-size: 10px; /* Adjust size as needed */
            }

            .scale-marker.quarter-hour,
            .scale-marker.half-hour,
            .scale-marker.three-quarter-hour {
                height: 10px; /* Shorter than the main hour markers */
                background-color: #666; /* A lighter color */
            }

            .scale-marker.quarter-hour,
            .scale-marker.three-quarter-hour {
                width: 0.5px; /* Thinner than the main hour markers */
            }

            .scale-marker.half-hour {
                width: 1px; /* Same as the main hour markers */
                height: 20px;
                top: 5px;
                z-index: 20000;
            }

            .scale-marker {
                width: 1px; /* Same as the main hour markers */
                height: 25px;
                top: 5px;
                z-index: 20000;
            }
        </style>
      <style>
.time-picker {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px; /* Spacing between swipers */
   z-index:300000;
}
.time-picker-header {
  cursor: move; /* Change cursor to indicate the area is draggable */
  background-color: #ddd; /* Light grey background */
  padding: 10px; /* Some padding */
  text-align: center; /* Center the text */
  border-top-left-radius: 5px; /* Rounded corners at the top */
  border-top-right-radius: 5px;
}
.swiper-container {
  height: 200px;
  width: 80px;
  overflow: hidden; /* Hide overflowed slides */
  z-index:300000;
}

.swiper-slide {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  opacity: 0.5; /* Lower opacity for non-active slides */
  user-select: none; /* Prevent text selection */
  -webkit-user-select: none; /* Safari */
  -moz-user-select: none; /* Firefox */
  -ms-user-select: none; /* Internet Explorer/Edge */
}

/* Active slide has a different style */
.swiper-slide-active {
  opacity: 1; /* Full opacity for the active slide */
  font-size: 30px; /* Larger font size for the active slide */
  color: #333;
  background: white;
  padding-top:8px;
    padding-bottom:8px;
  border-top: 1px solid grey; /* Border only on top */
  border-bottom: 1px solid grey; /* Border only on bottom */
}

/* Additional styles for the popup */
.time-picker-popup {
  display: none; /* Hide the popup initially */
  position: absolute;
  background: lightgrey;
  border: 1px solid grey;
  z-index: 990000;
  padding: 6px;
  border-radius: 5px;
}

/* Show the popup when it has the 'active' class */
.time-picker-popup.active {
  display: flex;
}

/* Style for the input field */
.timeInput {
  margin-bottom: 20px;
  cursor: pointer;
  display: block; /* Make input fields stack vertically */
}

/* Style for the done button */
#doneButton {
  margin-top: 10px;
  padding: 5px 10px;
  border: none;
  padding-left:10px;
  background-color: #007bff;
  color: white;
  border-radius: 5px;
  cursor: pointer;
}

#doneButton:hover {
  background-color: #0056b3;
}
</style>

            <style>
        .bordered {
            border: 2px solid blue;
            padding: 10px;
            margin: 10px 0;
        }






.floating-menu {
  position: fixed;
  top: 10px; /* You might want to reduce this for smaller screens */
  right: 10px;/* Adjust or reduce this value on smaller screens */
  z-index: 991000;
}



#menu-content {
  display: none;
  position: absolute;
  top: 100%; /* Position the menu right below the button */
  right: 0; /* Align the menu to the right edge of the button */
  background-color: #f9f9f9;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  padding: 12px 16px;
  z-index: 10000;
  border-radius: 10px; /* Optional: for rounded corners */
}
                
#menu-content a {
  padding: 10px 15px;
  text-decoration: none;
  display: block;
  color: black;
}

#menu-content a:hover {
  background-color: #f1f1f1;
}               

#menu-button {
  background-color: gray; /* Green */
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
  cursor: pointer;
  border-radius: 5px; /* Rounded corners */
}

#menu-button:hover {
  background-color: #45a049;
}







                
    </style>
    </head>
    <body>





















<div style=" width: 100%; box-sizing: border-box;">
 
     <div class="floating-menu">
  <button id="menu-button">â˜°</button>
  <div id="menu-content" class="menu-content">
    <a href="https://t.me/Luberth_Dijkman" target="_blank">t.me/Luberth_Dijkman</a>
    <a href="https://t.me/Arduino_ESP8266_ESP32" target="_blank">t.me/Arduino_ESP8266_ESP32</a>
    <a href="https://t.me/arduino_telegram_library" target="_blank">arduino_telegram_library</a>
     <hr style="width: 50%; margin: 0 auto; border: 0; height: 2px; background-color: greenyellow;">
    <a href="https://plnkr.co/edit/9calT1CLMaZKxqCm?preview" target="_blank">Edit alike on plnkr</a>
   <hr style="width: 50%; margin: 0 auto; border: 0; height: 2px; background-color: greenyellow;">
     <a href="https://ldijkman.github.io/async-esp-fs-webserver/ino/thermostat_web_flash/Telegram_WebApp/Telegram_WebApp.html">Other, Old & Tests</a> 
  </div>
</div>
</div>
        
      <div style="background-color: #f1f1f1; padding: 10px; text-align: center;">





<script>
document.getElementById('menu-button').addEventListener('click', function(event) {
  var menuContent = document.getElementById('menu-content');
  // Check if the menuContent is not displayed or is explicitly set to none
  if (menuContent.style.display === "none" || menuContent.style.display === "") {
    menuContent.style.display = "block";
  } else {
    menuContent.style.display = "none";
  }
  // Prevent event from propagating to the document level handler
  event.stopPropagation();
});

// Add event listener to the whole document
document.addEventListener('click', function(event) {
  var menuContent = document.getElementById('menu-content');
  // If the clicked element is not the menu or the button, and the menu is open, close it.
  if (!menuContent.contains(event.target) && !document.getElementById('menu-button').contains(event.target) && menuContent.style.display === "block") {
    menuContent.style.display = "none";
  }
});
</script>













          
<!--          
    <div id="urlDisplay" style="margin: 10px 0; font-size: 20px; font-weight: bold;"></div>
    %MDNS%<br>
    <a href="/setup" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> Setup </a>
    <a href="/edit" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> Edit </a>
    <a href="/ace" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;" title="serves /ace.html added a hide esp tree menu button to editor"> Ace </a>
   <a href="/mdns.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;" title="mdns scan list other devices in network"> mDNS Scan List </a>
   
    <a href="/time.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> time.html </a>
    <a href="/reset" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> Reset </a>
    <a href="https://ldijkman.github.io/async-esp-fs-webserver/" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;" title="Flash 4mb ESP8266 / ESP32"> Flash </a>

  <a href="https://ldijkman.github.io/async-esp-fs-webserver/WebSerialMonitor.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;" title="Browser serial usb monitor"> S-Mon </a>
   <br>
   <a href="/list.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> /list.html </a>
  
   <a href="/bulb.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> /bulb.html </a>
    <a href="/bulbs.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> /bulbs.html </a>
  
   <a href="/led" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> /led </a>
   <a href="/nerd.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> /nerd.html </a>
<a href="/SVG_Bulb.html" target="_blank" style="color: #007bff; text-decoration: none; margin: 0 10px;"> /SVG_Bulb.html </a>
</div>
-->

<script>
    // Display the current page URL
    document.getElementById('urlDisplay').textContent = document.location.href;
</script>
  <center>  
      <!--
      <h2>
       <a href="https://ldijkman.github.io/async-esp-fs-webserver/" target="_blank">Flash your 4mb ESP8266 / ESP32 inBrowser online </a>
      </h2>
      <br>
      -->

      
 <!-- Made with loads of questions to a Lazy Chat GPT4,<br><br> -->
<!--      
<a href="#" onclick="openInPopup('https://plnkr.co/edit/ikOuTjDZvqbPR5jr?preview'); return false;">Plunker</a> | 
<a href="#" onclick="openInPopup('https://codepen.io/ldijkman/pen/LYaOgvW'); return false;">CodePen</a> | 
<a href="#" onclick="openInPopup('https://jsfiddle.net/luberth/9cLvhm5y/'); return false;">JSFiddle</a>
<br>

      <br>
    <a href="https://t.me/Luberth_Dijkman" target="_blank">https://t.me/Luberth_Dijkman</a> <br> 
-->
<br>
The Art of Time Controlled. <br>


<h4>Sprinkler or Light On/Off Times <br>Visual TimeSlots Schedule.</h4>
<br><button onclick="window.location.reload();">Reload Page</button><br>
      Telegram WebApp MiniApp Web Storage Cloud Storage<br>
      <p id="webAppVersion">Loading version...</p>
<div id="jsonDisplay"></div>
      <br>
<script>
function openInPopup(url) {
  window.open(url, 'popupWindow', 'width=800, height=600, left=100, top=100, resizable=yes, scrollbars=yes, toolbar=yes, menubar=no, location=no, directories=no, status=yes');
}


</script>
<!--
        <a
            href="https://ldijkman.github.io/Ace_Seventh_Heaven/Seventh_Heaven.html"
            target="_blank"
            >Visual Scheduling with analog clock time picker ( My Version, Not made with Ai )</a
        ><br />
        <h2>Sprinkler or Light On/Off Times Schedule, Visual TimeSlots</h2>
        <br>
-->
<!--
        <a href="#" onclick="openInPopup('  https://codepen.io/ldijkman/pen/BabYXeo'); return false;">popup scrollwheel is to slow, fastmouse example with custom mouse scrollwheel listener</a><br>
-->

<script>
function reloadPage() {
    // Reloads the current document.
    location.reload();
}

           Telegram.WebApp.ready();

  document.addEventListener('DOMContentLoaded', function() {
    if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        
        const versionElement = document.getElementById('webAppVersion');
        // Update the text content of the paragraph with the version
        versionElement.textContent = 'Telegram Web App Version: ' + Telegram.WebApp.version;


    const key = 'user_data';

    Telegram.WebApp.CloudStorage.getItem(key, (error, value) => {
        if (error) {
            console.error('Error retrieving JSON string:', error);
            document.getElementById('jsonDisplay').innerText = 'Error retrieving JSON string.';
        } else {
            console.warn('Retrieved JSON string:', value);
            document.getElementById('jsonDisplay').innerText = value ? value : 'No data found.';
        }
    });


        
    }
});  
    
    


</script>
<div id="The_Art_of_Time_Controlled" class="The_Art_of_Time_Controlled"  style="width: 100%; box-sizing: border-box;">
        <div id="times-inputs">
            <!-- Your input fields go here -->
        </div>
</div>      

        <button id="save-times" hidden>Save Times</button>
<button id="send-times-btn" style="margin-top: 8px; height: 40px; /* Adjusted height */
    box-sizing: border-box;
    cursor: pointer;
    background-color: #0088cc;
    border-radius: 3px;
    border: none; /* Use 'border: none;' if you don't want a border, or adjust 'border-color' */
    padding: 8px;
    margin: 8px;
    font-family: Arial, Helvetica, sans-serif;
    font-weight: bold;
    font-size: 16px;
    color: #FFF;
    text-decoration: none;">  
    <img src="https://telegram.org/img/oauth/tg_button_small.png" alt="Send Icon" style="vertical-align: middle; margin-right: 5px; height: 24px;"> <!-- Adjusted image height -->
  Send Times To Bot 
</button> 
 <br><br><br><br> 
        <div id="time-bar-container" style="width: 98%; box-sizing: border-box;">
            <div id="time-bar"> 
                <!-- Your time segments go here -->
            </div>
        </div>
 
        <div id="time-scale-container" style="width: 98%; box-sizing: border-box;">
            <!-- Your scale markers and labels go here -->
        </div>
        <br /><br /><br /><br />  <br /><br /><br />
               <div id="current-time">Current Time: 15:11:06</div>
        <div id="time-status" class="status-on">
            The current time is within an ON interval.
        </div>
        <br /><br />
a click on time-bar adds a new time-segment timeslot<br>
<br>
Reload Page, Sorts the inputfields / timeslots
Browser local storage<br />
<br>
click a timeslot to see a popup for 5 seconds<br>
also highlights the corresponing inputfields<br>
<br>

        <div id="saved-times-list"></div>

        <br />
        <br /><br />
              <a
            href="https://ldijkman.github.io/Ace_Seventh_Heaven/Seventh_Heaven.html"
            target="_blank"
            >Visual Scheduling with analog clock time picker <br>( My Version, Not made with Ai )</a
        ><br /><br>

      
   
<!-- Time Picker Popup Container -->
<!-- Time Picker Popup Container -->
<div class="time-picker-popup" id="timePickerPopup">
  <!-- Draggable Header -->
  <div class="time-picker-header" draggable="true" id="dragHeader">D<br>r<br>a<br>g<br></div>
  <!-- Time Picker Container -->
  <div class="time-picker">
    <!-- Swiper for hours -->
    <div class="swiper-container hour-swiper">
      <div class="swiper-wrapper" id="hourWrapper"></div>
    </div>
    <!-- Swiper for minutes -->
    <div class="swiper-container minute-swiper">
      <div class="swiper-wrapper" id="minuteWrapper"></div>
    </div>
  </div>
  <!-- Done Button -->
  <button id="doneButton" type="button">Done</button>
</div>
      
      
            <!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
      
        <script>
            let defaultOnOffTimes = [
                { on: 5 * 60, off: 5 * 60 + 15 },
                { on: 12 * 60, off: 12 * 60 + 15 },
                { on: 15 * 60, off: 15 * 60 + 15 },
                { on: 19 * 60, off: 19 * 60 + 15 },
                { on: 22 * 60, off: 22 * 60 + 15 },
                { on: 23 * 60, off: 23 * 60 + 15 },
            ];

            let storedOnOffTimes = JSON.parse(
                localStorage.getItem('onOffTimes')
           );
            /*
           const key = 'storedOnOffTimes';

            Telegram.WebApp.CloudStorage.getItem(key, (error, value) => {
                if (error) {
                    console.error('Error retrieving JSON string:', error);
                } else {
                    console.warn('Retrieved JSON string:', value);
                }
            });
            */
            let onOffTimes =
                storedOnOffTimes && storedOnOffTimes.length > 0
                    ? storedOnOffTimes
                    : defaultOnOffTimes;

// Function to sort the on/off times by the 'on' property
function sortOnOffTimesByStartTime(onOffTimes) {
    return onOffTimes.sort((a, b) => a.on - b.on);
}

// Call the function to sort the array
onOffTimes = sortOnOffTimesByStartTime(onOffTimes);



// Add a function to create a new time entry
function createNewTimeEntry() {
    // Define a new default time entry, for example, starting at 00:00 and ending at 00:15
    const newEntry = { on: 0, off: 15 };

    // Push the new entry to the onOffTimes array
    onOffTimes.push(newEntry);

    // Update the input fields, the visual time bar, and the display of saved times
    createInputFields(onOffTimes);
    updateTimeBar(onOffTimes);
    localStorage.setItem('onOffTimes', JSON.stringify(onOffTimes)); // Save the updated array to localStorage
    displaySavedTimes();
    attachTimePickerEventListeners();
    sendData(onOffTimes);
}
/////////////////////////////
/////////////////////////////



///////////////////////////////////
///////////////////////////////
// Now call createInputFields initially to set up the existing inputs and the add button
createInputFields(onOffTimes);

function createInputFields(onOffTimes) {
    const timesInputs = document.getElementById('times-inputs');
    timesInputs.innerHTML = ''; // Clear existing inputs

    onOffTimes.forEach((entry, index) => {
        const timeEntryDiv = document.createElement('div');
        timeEntryDiv.className = 'time-entry';

        const onInput = document.createElement('input');
        onInput.className = 'time-input';
        onInput.type = 'text';
        onInput.style.color = 'green';
        onInput.value = minutesToTime(entry.on);
        onInput.dataset.index = index;
        onInput.dataset.type = 'on';
        onInput.readOnly = true; // Make the input read-only no keyboard popup on phone

        const offInput = document.createElement('input');
        offInput.className = 'time-input';
        offInput.type = 'text';
        offInput.style.color = 'red';
        offInput.value = minutesToTime(entry.off);
        offInput.dataset.index = index;
        offInput.dataset.type = 'off';
        offInput.readOnly = true; // Make the input read-only no keyboard popup on phone

        // Create a delete button for each on/off pair
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.dataset.index = index;
        deleteButton.onclick = function() {
            // Remove the entry from the onOffTimes array
            onOffTimes.splice(this.dataset.index, 1);
            // Update the display
            createInputFields(onOffTimes);
            updateTimeBar(onOffTimes);
            localStorage.setItem('onOffTimes', JSON.stringify(onOffTimes)); // Save the updated array to localStorage
            displaySavedTimes();
            attachTimePickerEventListeners();
            sendData(onOffTimes);
        };

        

        timeEntryDiv.appendChild(document.createTextNode('On: '));
        timeEntryDiv.appendChild(onInput);
        timeEntryDiv.appendChild(document.createTextNode(' Off: '));
        timeEntryDiv.appendChild(offInput);
        timeEntryDiv.appendChild(deleteButton); // Add the delete button to the time entry

        timesInputs.appendChild(timeEntryDiv);

        
    });
    
}


/*
// Ensure the DOM is fully loaded before manipulating it
document.addEventListener('DOMContentLoaded', function() {
    // Get the div where you want to add the button
    const theArtOfTimeControlled = document.getElementById('The_Art_of_Time_Controlled');

    // Create a button for creating new time entries
    const addTimeButton = document.createElement('button');
    addTimeButton.textContent = 'Add Time';
    addTimeButton.onclick = createNewTimeEntry; // Ensure this function is defined
    addTimeButton.style.position = 'absolute';
      addTimeButton.style.left = '0px';

    // Insert the button into the div
    theArtOfTimeControlled.insertBefore(addTimeButton, theArtOfTimeControlled.firstChild);

 
    // Create a line break element
    const lineBreak = document.createElement('br');

    // Insert the line break after the button
    theArtOfTimeControlled.insertBefore(lineBreak, addTimeButton.nextSibling);


});
 */  
            function timeToMinutes(timeString) {
                const [hours, minutes] = timeString.split(':').map(Number);
                return (hours % 24) * 60 + minutes;
            }

            function minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours
                    .toString()
                    .padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }
            
          
            
            
            
            
            
            
            
            
            
            function displaySavedTimes() {
                // Retrieve saved times from localStorage
                const savedTimes =
                    JSON.parse(localStorage.getItem('onOffTimes')) || [];
                const savedTimesList = document.getElementById(
                    'saved-times-list'
                );

                // Clear existing list
                savedTimesList.innerHTML = '';

                // Create a list element to hold the saved times
                const list = document.createElement('ul');

                // Loop through each saved time and append it to the list
                savedTimes.forEach((timeEntry, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Entry ${
                        index + 1
                    }: On at ${minutesToTime(
                        timeEntry.on
                    )}, Off at ${minutesToTime(timeEntry.off)}`;
                    listItem.textContent += ` , in minutes : On at ${timeEntry.on}, Off at ${timeEntry.off}`;
                    list.appendChild(listItem);
                    console.info(listItem.textContent);
                });

                // Append the list to the saved times list container
                savedTimesList.appendChild(list);
            }

            function saveNewTimes() {
                const inputs = document.querySelectorAll('.time-input');
                inputs.forEach((input) => {
                    const index = input.dataset.index;
                    const type = input.dataset.type;
                    const timeValue = timeToMinutes(input.value);

                    if (type === 'on') {
                        onOffTimes[index].on = timeValue;
                    } else if (type === 'off') {
                        onOffTimes[index].off = timeValue;
                    }
                });
                // Save the updated onOffTimes array to localStorage
                localStorage.setItem('onOffTimes', JSON.stringify(onOffTimes));
                updateTimeBar(onOffTimes); // Update the time bar with new times

                // Display the saved times on the page
                displaySavedTimes();
            }

            document
                .getElementById('save-times')
                .addEventListener('click', () => {
                    saveNewTimes();
                    updateCurrentTimeStatus(onOffTimes);
                    createInputFields(onOffTimes);
                });

            // Display saved times when the page loads
            displaySavedTimes();

            function isTimeOn(minutesOfDay, onOffTimes) {
                return onOffTimes.some(
                    ({ on, off }) => minutesOfDay >= on && minutesOfDay < off
                );
            }

            function updateCurrentTimeStatus(onOffTimes) {
                const currentTime = new Date();
                const currentTimeInMinutes =
                    currentTime.getHours() * 60 + currentTime.getMinutes();
                const currentTimeStr = currentTime.toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                });

                const timeStatus = document.getElementById('time-status');
                const currentTimeDisplay = document.getElementById(
                    'current-time'
                );

                const isCurrentlyOn = isTimeOn(
                    currentTimeInMinutes,
                    onOffTimes
                );
                timeStatus.textContent = isCurrentlyOn
                    ? 'The current time is within an ON interval.'
                    : 'The current time is not within an ON interval.';
                timeStatus.className = isCurrentlyOn
                    ? 'status-on'
                    : 'status-off'; // Apply the appropriate class
                currentTimeDisplay.textContent = `Current Time: ${currentTimeStr}`;
            }


// function to remove the leading zero for hours less than 10:
/*
function minutesToTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    // Format hours without leading zero if less than 10
    const formattedHours = hours < 10 ? hours.toString() : hours.toString().padStart(2, '0');
    // Always format minutes with leading zero
    const formattedMinutes = mins.toString().padStart(2, '0');
    return `${formattedHours}:${formattedMinutes}`;
}
*/ 
function minutesToTime(minutes) {
    // Convert minutes to hours and minutes
    let hours = Math.floor(minutes / 60);
    let mins = minutes % 60;
    
    // Format hours and minutes to strings with leading zeros if necessary
    let hoursStr = hours.toString().padStart(2, '0');
    let minsStr = mins.toString().padStart(2, '0');
    
    // Check if the time equals 00:00 and adjust to 24:00 if necessary
    if (hoursStr === '00' && minsStr === '00') {
        hoursStr = '24';
    }
    
    return `${hoursStr}:${minsStr}`;
}


function updateTimeBar(onOffTimes) {
    const timeBar = document.getElementById('time-bar');
    // Clear existing segments
    while (timeBar.firstChild) {
        timeBar.removeChild(timeBar.firstChild);
    }

    onOffTimes.forEach(({ on, off }, index) => {
        const segment = document.createElement('div');
        segment.className = 'time-segment';
        segment.style.left = `${(on / (24 * 60)) * 100}%`;
        segment.style.width = `${((off - on) / (24 * 60)) * 100}%`;

        // Attach click event listener to the segment
        segment.addEventListener('click', () => {
            showPopup(index);
        });

        timeBar.appendChild(segment);


        // Start label
        const startLabel = document.createElement('div');
        startLabel.className = 'time-label start-label';
        startLabel.textContent = minutesToTime(on); // Will format correctly based on updated function
        startLabel.style.left = segment.style.left;
        timeBar.appendChild(startLabel);

        // Modify the bottom offset for even indexes
        //if (index % 2 === 0) {
        //   startLabel.style.bottom = '-20px'; // 5px lower for every even label
        //} else {
        //    startLabel.style.bottom = '-30px';
        //}

        // End label
        const endLabel = document.createElement('div');
        endLabel.className = 'time-label end-label';
        endLabel.textContent = minutesToTime(off); // Will format correctly based on updated function
        timeBar.appendChild(endLabel);
        
        // Position the end label after it has been added to the DOM
        endLabel.style.left = `calc(${segment.style.left} + ${segment.style.width})`;
        // Adjust the position based on the label's width
        const endLabelWidth = endLabel.offsetWidth;
        const endLabelLeft = parseFloat(endLabel.style.left) - (endLabelWidth / 2);
        endLabel.style.left = `${endLabelLeft}px`;

        // Modify the bottom offset for even indexes
        //if (index % 2 === 0) {
        //    endLabel.style.bottom = '-30px'; // 5px lower for every even label
        //} else {
        //    endLabel.style.bottom = '-40px';
        //}
    });
}
/* 

function updateTimeBar(onOffTimes) {
    const timeBar = document.getElementById('time-bar');
    // Clear existing segments
    timeBar.innerHTML = '';

    onOffTimes.forEach(({ on, off }, index) => {
        const segment = document.createElement('div');
        segment.className = 'time-segment';

        // Calculate left position based on the 'on' time
        const leftPercentage = (on / 1440) * 100;
        segment.style.left = `${leftPercentage}%`;

        // Adjust off time if it's 0 (midnight) to be 1440 (for calculation purposes)
        const adjustedOffTime = off === 0 ? 1440 : off;

        // Calculate width percentage, ensuring we account for crossing over midnight
        const duration = adjustedOffTime - on;
        const widthPercentage = (duration / 1440) * 100;
        segment.style.width = `${widthPercentage}%`;

        timeBar.appendChild(segment);
    });
} 

*/

            // Move the showPopup function outside of the updateTimeBar function
            function showPopup(index) {
                const onOffTime = onOffTimes[index];
                const popup = document.createElement('div');

                popup.id = 'time-popup';
                popup.style.position = 'absolute';
                popup.style.left = '50%';
                popup.style.top = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
                popup.style.backgroundColor = '#fff';
                popup.style.padding = '11px';
                popup.style.border = '1px solid #000';
                popup.style.zIndex = '2000';
                popup.style.color = 'red';
                popup.textContent = `Set time for: On at ${minutesToTime(
                    onOffTime.on
                )}, Off at ${minutesToTime(onOffTime.off)}`;

                // Append the popup to the body
                document.body.appendChild(popup);

                // Automatically close the popup after 2 seconds
                setTimeout(function () {
                    popup.remove();
                }, 5000);
                const timeEntries = document.querySelectorAll('.time-entry');
    const relevantEntry = timeEntries[index];
              
                  // Save the original background color
    const originalBackgroundColor = relevantEntry.style.backgroundColor;

    // Highlight the background color of the relevantEntry
    relevantEntry.style.backgroundColor = 'greenyellow';

    // Remove the highlight after 5 seconds
    setTimeout(function () {
        relevantEntry.style.backgroundColor = originalBackgroundColor;
    }, 3000);
            }

            document
                .getElementById('save-times')
                .addEventListener('click', () => {
                    saveNewTimes();
                    updateCurrentTimeStatus(onOffTimes);
                    createInputFields(onOffTimes);
                    sendData(onOffTimes);
                });

            createInputFields(onOffTimes);
            updateCurrentTimeStatus(onOffTimes); 
           
            updateTimeBar(onOffTimes);
           

            setInterval(() => {
                updateCurrentTimeStatus(onOffTimes);
            }, 1000);

            function createScale() {
                const scaleContainer = document.getElementById(
                    'time-scale-container'
                );
                scaleContainer.innerHTML = ''; // Clear existing scale

                for (let i = 0; i <= 24; i++) {
                    // Create a marker for each hour
                    const marker = document.createElement('div');
                    marker.className = 'scale-marker';
                    marker.style.left = `${(i / 24) * 100}%`;
                    scaleContainer.appendChild(marker);

                    // Create a label for each hour
                    const label = document.createElement('div');
                    label.className = 'scale-label';
                    label.style.left = `${(i / 24) * 100}%`;
                    label.textContent = i;
                    scaleContainer.appendChild(label);

                    // Skip the quarter, half, and three-quarter-hour marks for the last hour marker
                    if (i === 24) continue;

                    // Create a marker for each quarter hour (15 minutes)
                    const quarterMarker = document.createElement('div');
                    quarterMarker.className = 'scale-marker quarter-hour';
                    quarterMarker.style.left = `${((i + 0.25) / 24) * 100}%`;
                    scaleContainer.appendChild(quarterMarker);

                    // Create a marker for each half hour (30 minutes)
                    const halfMarker = document.createElement('div');
                    halfMarker.className = 'scale-marker half-hour';
                    halfMarker.style.left = `${((i + 0.5) / 24) * 100}%`;
                    scaleContainer.appendChild(halfMarker);

                    // Create a marker for each three-quarter hour (45 minutes)
                    const threeQuarterMarker = document.createElement('div');
                    threeQuarterMarker.className =
                        'scale-marker three-quarter-hour';
                    threeQuarterMarker.style.left = `${
                        ((i + 0.75) / 24) * 100
                    }%`;
                    scaleContainer.appendChild(threeQuarterMarker);
                }
            }

            // Call createScale function after defining it
            createScale();

// Function to add a new div at the top of the time-bar-container
function addTopDivToTimeBarContainer() {
    const timeBarContainer = document.getElementById('time-bar-container');
    const topDiv = document.createElement('div');

    // Set the styles for the new div
    topDiv.style.position = 'relative';
  topDiv.id = 'SunRise_SunSet';
    topDiv.style.left = '0';
    topDiv.style.top = '-5px';
    topDiv.style.width = '100%';
    topDiv.style.height = '10px';
    topDiv.style.backgroundColor = 'yellow'; // Example color, change as needed
  topDiv.style.zIndex = '-1';

    // Append the new div to the time-bar-container
    timeBarContainer.appendChild(topDiv);
}
/*
function createRiseNightOverlay() {
    const sunRiseSunSetContainer = document.getElementById('SunRise_SunSet');
    const overlay = document.createElement('div');
    overlay.id = 'rise_night';

    // Since the container starts at 00:00 by default, we only need to calculate the end percent for 07:00 hours
    const endPercent = (7 / 24) * 100; // 07:00 hours as a percentage of a 24-hour day

    // Set the styles for the overlay
    overlay.style.position = 'absolute';
    overlay.style.left = '0'; // Start at 00:00
    overlay.style.width = `${endPercent}%`; // End at the calculated percentage for 07:00
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'lightgrey';
    overlay.style.zIndex = '10'; // Ensure it's above the container background but below other elements

    // Append the overlay to the sunRiseSunSetContainer
    sunRiseSunSetContainer.appendChild(overlay);
}

// Call the function to add the overlay after the SunRise_SunSet container is rendered
createRiseNightOverlay();
*/

// Call the function to add the top div
addTopDivToTimeBarContainer();

const timeBarContainer = document.getElementById('time-bar');
timeBarContainer.addEventListener('click', function(event) {
    // Check if the click was on the time-bar and not on a time-segment
    if (event.target === this) {
        const timeBarRect = this.getBoundingClientRect();
        const clickedPosition = event.clientX - timeBarRect.left;
        const clickedTimeFraction = clickedPosition / timeBarRect.width;
        const totalMinutesInDay = 24 * 60;
        const clickedTimeInMinutes = Math.floor(clickedTimeFraction * totalMinutesInDay);

        // Snap the start time to the nearest 15 minutes
        const snappedStartTime = Math.floor(clickedTimeInMinutes / 15) * 15;
        const endTime = (snappedStartTime + 15) % totalMinutesInDay; // 15 minutes duration, wrap around at midnight

        // Create a new time slot
        const newTimeSlot = { on: snappedStartTime, off: endTime };

        // Add the new time slot to onOffTimes array and update the display
        onOffTimes.push(newTimeSlot);
        createInputFields(onOffTimes); // Refresh input fields to include the new time slot
        updateTimeBar(onOffTimes);
        localStorage.setItem('onOffTimes', JSON.stringify(onOffTimes)); // Save the updated array to localStorage
        displaySavedTimes();
        attachTimePickerEventListeners();
        sendData(onOffTimes);
    }
});


            
        </script>
       <!-- <script src="https://ldijkman.github.io/Ace_Seventh_Heaven/console.js"></script> -->
       
      
   <!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>

<script>
// Function to create Swiper slides
function createSwiperSlides(elementId, start, end, step = 1) {
  const wrapper = document.getElementById(elementId);
  // Add additional slides to the beginning for a smoother start
  for (let i = start ; i <= end ; i += step) {
    const slide = document.createElement('div');
    slide.className = 'swiper-slide';
    // Use modulo to create a loop effect
    const displayValue = (i + 60) % 60; // Adjust for negative values
    slide.textContent = displayValue.toString().padStart(2, '0');
    wrapper.appendChild(slide);
  }
}

// Create hour and minute slides
createSwiperSlides('hourWrapper', 0, 23);
createSwiperSlides('minuteWrapper', 0, 59);


// Declare Swiper instances
let hourSwiper, minuteSwiper;

// Initialize hour swiper with mousewheel control
hourSwiper = new Swiper('.hour-swiper', {
  direction: 'vertical',
  loop: true,
   slideToClickedSlide: true,
  slidesPerView: 5,
  centeredSlides: true,
  spaceBetween: -10,
  speed: 0,
  touchRatio: 2, // Increase this number to move more per drag
 // Enable keyboard control
  keyboard: {
    enabled: true,
    onlyInViewport: true, // Keyboard control will be enabled only when the swiper is in viewport
  },
});

// Initialize minute swiper with mousewheel control
minuteSwiper = new Swiper('.minute-swiper', {
  direction: 'vertical',
  loop: true,
   slideToClickedSlide: true,
  slidesPerView: 5,
  centeredSlides: true,
  spaceBetween: -10,
  speed: 0,
  touchRatio: 2, // Increase this number to move more per drag
  // Enable keyboard control
  keyboard: {
    enabled: true,
    onlyInViewport: true, // Keyboard control will be enabled only when the swiper is in viewport
  },
});




// Function to handle custom mouse wheel events for hours
function customMouseWheelHandlerHours(event) {
  // Prevent the default scroll behavior
  event.preventDefault();

  // Determine the direction of the scroll
  const isScrollingUp = event.deltaY < 0;

  // Adjust the Swiper's position based on the scroll direction
  if (isScrollingUp) {
    // Scroll up (decrease hours)
    hourSwiper.slidePrev();
  } else {
    // Scroll down (increase hours)
    hourSwiper.slideNext();
  }
}

// Add the custom mouse wheel event listener to the hour swiper container
document.querySelector('.hour-swiper').addEventListener('wheel', customMouseWheelHandlerHours);

// Function to handle custom mouse wheel events
function customMouseWheelHandler(event) {
  // Prevent the default scroll behavior
  event.preventDefault();

  // Determine the direction of the scroll
  const isScrollingUp = event.deltaY < 0;

  // Adjust the Swiper's position based on the scroll direction
  if (isScrollingUp) {
    // Scroll up (decrease minutes)
    minuteSwiper.slidePrev();
  } else {
    // Scroll down (increase minutes)
    minuteSwiper.slideNext();
  }
}

// Add the custom mouse wheel event listener to the minute swiper container
document.querySelector('.minute-swiper').addEventListener('wheel', customMouseWheelHandler);



let currentInput = null; // Keep a reference to the currently focused input

// Function to update the selected time display
function updateSelectedTime() {
  const selectedHour = hourSwiper.slides[hourSwiper.activeIndex].textContent;
  const selectedMinute = minuteSwiper.slides[minuteSwiper.activeIndex].textContent;
  if (currentInput) {
    currentInput.value = `${selectedHour}:${selectedMinute}`;
    // Find the index of the current input among all elements with the 'timeInput' class
    const inputIndex = Array.from(document.querySelectorAll('.timeInput')).findIndex(input => input === currentInput);
    // Echo the current input value and the index of the input field
    console.info('Time updated to:', currentInput.value, 'for input field at index:', inputIndex);     }
}

// Function to parse time and set Swiper sliders
function setTimeInSwiper(inputTime) {
  let hour = 0;
  let minute = 0;
  
  // Check if input time is valid
  if (inputTime && inputTime.includes(':')) {
    const parts = inputTime.split(':');
    hour = parseInt(parts[0], 10);
    minute = parseInt(parts[1], 10);
  }

  // Set Swiper to the corresponding hour and minute
  hourSwiper.slideToLoop(hour , 0, false);
  minuteSwiper.slideToLoop(minute, 0, false);
}

// Function to show and hide the time picker
function showTimePicker() {
  document.getElementById('timePickerPopup').classList.add('active');
}

function hideTimePicker() {
  document.getElementById('timePickerPopup').classList.remove('active');
}

// Function to position the popup below the input field
function positionTimePicker(inputField) {
  const popup = document.getElementById('timePickerPopup');
  const rect = inputField.getBoundingClientRect();
  popup.style.top = `${rect.bottom + window.scrollY}px`;
  popup.style.left = `${rect.left + window.scrollX}px`;
}

// Set up event listeners for input fields
document.querySelectorAll('.time-input').forEach(input => {
  input.addEventListener('focus', function() {
    currentInput = input; // Set the current input
    positionTimePicker(input);
    setTimeInSwiper(input.value); // Set the time in the swiper based on input value
    showTimePicker();
  });
});

// Add click event listener for the "Done" button
        // Modify the Done button event listener to reset the time picker and trigger the save function
// Modify the Done button event listener to reset the time picker and trigger the save function
        document.getElementById('doneButton').addEventListener('click', function() {
            hideTimePicker();
            if (currentInput) {
                updateSelectedTime();
                currentInput.blur(); // Remove focus from the current input
                currentInput = null; // Clear the current input reference
                document.getElementById('save-times').click(); // Trigger save
                // Re-attach event listeners to input fields to allow showing the time picker again
                attachTimePickerEventListeners();
            }
        });

        // Function to attach event listeners to input fields
        function attachTimePickerEventListeners() {
            document.querySelectorAll('.time-input').forEach(input => {
                input.removeEventListener('focus', focusHandler); // Remove existing event handler, if any
                input.addEventListener('focus', focusHandler); // Attach new event handler
            });
        }

        // Event handler function for focus event
        function focusHandler() {
            currentInput = this; // Set the current input
            positionTimePicker(this);
            setTimeInSwiper(this.value); // Set the time in the swiper based on input value
            showTimePicker();
        }

        let allowTimePickerToShow = true; // Flag to control when the time picker can be shown

        // Set up event listeners for input fields
        document.querySelectorAll('.time-input').forEach(input => {
            input.addEventListener('focus', function() {
                if (allowTimePickerToShow) {
                    currentInput = input; // Set the current input
                    positionTimePicker(input);
                    setTimeInSwiper(input.value); // Set the time in the swiper based on input value
                    showTimePicker();
                    allowTimePickerToShow = false; // Prevent the time picker from showing again until reset
                }
            });
        });

// Listen to slide change events on both swipers
hourSwiper.on('slideChange', () => updateSelectedTime());
minuteSwiper.on('slideChange', () => updateSelectedTime());
  
  
  
  
  
  
  
  
  
  
  
  
/*
add a marker on time-bar where current time is?

To add a marker on the #time-bar that shows the current time, you can create a new element and position it according to the current time relative to the 24-hour scale of the time bar.

Here's an example of how you can add this feature using JavaScript:

add a label above current-time-marker with the current time?

To add a label above the current-time-marker that shows the current time, you can create a new element for the label and position it right above the marker on the #time-bar. Here's how you can update the updateCurrentTimeMarker function to include a label:

add seconds to current time label?

To include seconds in the current time label, you simply need to update the timeString within the updateCurrentTimeMarker function to fetch and display the seconds as well. Here's the modified function:

if current time is within change bleu time label to green?

To change the color of the current time label to green if the current time is within one of the time segments, you can modify the updateCurrentTimeMarker function. This function should check if the current time falls within any of the time segments and change the color of the label accordingly.

Here's how you can modify the updateCurrentTimeMarker function to implement this feature:
*/


function updateCurrentTimeMarker() {
    const timeBar = document.getElementById('time-bar');
    const currentTime = new Date();
    const currentHours = currentTime.getHours();
    const currentMinutes = currentTime.getMinutes();
    const currentSeconds = currentTime.getSeconds();
    const currentTimeInMinutes = currentHours * 60 + currentMinutes;
    const percentageOfDay = (currentTimeInMinutes / (24 * 60)) * 100;

    // Determine if the current time is within any of the time segments
    const isWithinSegment = onOffTimes.some(({ on, off }) => {
        return currentTimeInMinutes >= on && currentTimeInMinutes <= off;
    });

    // Format the current time string
    const hoursStr = currentHours.toString().padStart(2, '0');
    const minutesStr = currentMinutes.toString().padStart(2, '0');
    const secondsStr = currentSeconds.toString().padStart(2, '0');
    const timeString = `${hoursStr}:${minutesStr}:${secondsStr}`;

    // Remove the existing current time marker and label if they exist
    const existingMarker = document.getElementById('current-time-marker');
    const existingLabel = document.getElementById('current-time-label');
    if (existingMarker) {
        timeBar.removeChild(existingMarker);
    }
    if (existingLabel) {
        timeBar.removeChild(existingLabel);
    }

    // Create a new current time marker
    const currentTimeMarker = document.createElement('div');
    currentTimeMarker.id = 'current-time-marker';
    currentTimeMarker.style.position = 'absolute';
    currentTimeMarker.style.left = `${percentageOfDay}%`;
    currentTimeMarker.style.top = '-30px';
    currentTimeMarker.style.bottom = '0';
    currentTimeMarker.style.width = '1px';
    currentTimeMarker.style.backgroundColor = 'green';

    // Create a label for the current time
    const currentTimeLabel = document.createElement('div');
    currentTimeLabel.id = 'current-time-label';
    currentTimeLabel.textContent = timeString;
    currentTimeLabel.style.position = 'absolute';
    currentTimeLabel.style.left = `calc(${percentageOfDay}% - 25px)`;
    currentTimeLabel.style.bottom = '175%';
    currentTimeLabel.style.backgroundColor = isWithinSegment ? 'greenyellow' : '#fff'; // Change color if within a segment
    currentTimeLabel.style.color = 'blue';
    currentTimeLabel.style.padding = '2px 5px';
    currentTimeLabel.style.fontSize = '0.75rem';
    currentTimeLabel.style.whiteSpace = 'nowrap';
    currentTimeLabel.style.border = '1px solid blue';
    currentTimeLabel.style.borderRadius = '3px';

    // Append the marker and label to the time bar
    timeBar.appendChild(currentTimeMarker);
    timeBar.appendChild(currentTimeLabel);
}

// Initial call to create the marker and label
updateCurrentTimeMarker();

// Update the current time marker and label every second
setInterval(updateCurrentTimeMarker, 1000);
</script>
    </body>
</html>

<!-- Copyright 2023 Dirk Luberth Dijkman Bangert 30 1619GJ Andijk The Netherlands     -->

<pre>
</pre>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
    console.log('moved console and changed size of console.');
    var consoleLogDiv = document.querySelector('#console-log-div');
    
    if (consoleLogDiv) {
      consoleLogDiv.style.left = '400px';    // Example: 
      //consoleLogDiv.style.top = '10px';    // Example: 
      consoleLogDiv.style.height = '200px';  // Example: 
    }
    }, 5000); // 3000 milliseconds = 3 seconds
  });
</script>



<script>

// Function to make the time picker popup draggable
function makePopupDraggable(popup, header) {
  var posX = 0,
      posY = 0,
      posInitialX = 0,
      posInitialY = 0;

  // Mouse events
  header.onmousedown = dragMouseDown;
  // Touch events
  header.ontouchstart = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    if (e.type === "touchstart") {
      // Get the initial touch position
      posInitialX = e.touches[0].clientX;
      posInitialY = e.touches[0].clientY;
    } else {
      // Get the initial cursor position
      posInitialX = e.clientX;
      posInitialY = e.clientY;
    }
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
    // Touch events
    document.ontouchend = closeDragElement;
    document.ontouchmove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    if (e.type === "touchmove") {
      // Calculate the new touch position
      posX = posInitialX - e.touches[0].clientX;
      posY = posInitialY - e.touches[0].clientY;
      posInitialX = e.touches[0].clientX;
      posInitialY = e.touches[0].clientY;
    } else {
      // Calculate the new cursor position
      posX = posInitialX - e.clientX;
      posY = posInitialY - e.clientY;
      posInitialX = e.clientX;
      posInitialY = e.clientY;
    }
    // Set the new position of the popup
    popup.style.top = (popup.offsetTop - posY) + "px";
    popup.style.left = (popup.offsetLeft - posX) + "px";
  }

  function closeDragElement() {
    // Stop moving when mouse button is released or touch ends
    document.onmouseup = null;
    document.onmousemove = null;
    document.ontouchend = null;
    document.ontouchmove = null;
  }
}

// Call the function with the popup and header elements
var popup = document.getElementById("timePickerPopup");
var header = document.getElementById("dragHeader");
makePopupDraggable(popup, header);
</script>

<!-- Copyright 2023 Dirk Luberth Dijkman Bangert 30 1619GJ Andijk The Netherlands     -->
<hr>



  
  <script>
  
 // maybe must be a http connection  // save file // open from disk
  // Create a new WebSocket connection ESP32
  // Log the WebSocket connection attempt
  console.warn('WebSocket connection to ESP32');

  // Construct the WebSocket URL using the current location's hostname
  const wsUrl = `ws://${window.location.hostname}/ws`;
  const ws = new WebSocket(wsUrl);

  // Function to send data to the WebSocket server
  function sendData(data) {
    console.info("function sendData");
    // Check if the WebSocket connection is open
    if (ws.readyState === WebSocket.OPEN) {
      // Serialize the data into a JSON string
      const dataToSend = JSON.stringify(data);
      // Send the data over the WebSocket connection
      ws.send(dataToSend);
      console.info('Data sent:', dataToSend);
    } else {
      console.error('WebSocket connection is not open.');
    }
  }


    


  // When the connection is open, send the on/off times
  ws.onopen = function() {
    console.info("ws.onopen");
    sendData(onOffTimes);
  };

  // Log messages received from the server
  ws.onmessage = function(event) {
    console.info("ws.onmessage");
    console.log('Message from server:', event.data);
  };

  // Handle any errors that occur
  ws.onerror = function(error) {
    console.info("ws.onerror");
    console.error('WebSocket Error:', error);
  };

  // Handle when the connection is closed
  ws.onclose = function(event) {
    console.info("ws.onclose");
    console.log('WebSocket connection closed:', event);
  };

  // Now you can call sendData() whenever you need to send data
  // Example: sendData({ "message": "Hello from the browser!" });
</script>



<script>

if (window.location.protocol === "https:") {
    console.info("The document location is secure (https).");
    console.info("HTTPS:// No Good for WS Websocket, needs HTTP:// save page and load from disk?.");
} else {
    console.info("The document location is not secure (not https).");
    console.info("Good for WS Websocket.");

}



function sendTimesToBot() {
    // Ensure onOffTimes is up to date and contains the times you want to send

   // Sort the onOffTimes array based on the "on" value
    onOffTimes.sort((a, b) => a.on - b.on);
    
const jsonString = JSON.stringify(onOffTimes);
    const key = 'user_data';
          
           Telegram.WebApp.CloudStorage.setItem(key, jsonString, (error, success) => {
               if (error) {
                   console.error('Error storing JSON string:', error);
               } else if (success) {
                   console.warn('JSON string stored successfully');
               }
            });
    if (Telegram.WebApp.ready) {
        Telegram.WebApp.sendData(JSON.stringify(onOffTimes));
        console.log("On/Off times sent to bot:", onOffTimes);
    } else {
        console.error("Telegram WebApp is not ready.");
    }
}

document.getElementById('send-times-btn').addEventListener('click', sendTimesToBot);
Telegram.WebApp.expand();

</script>  
<!--
    <h1>Welcome to Telegram Web App Demo</h1>
    <p id="userId" class="bordered">User ID: </p>
    <p id="userName" class="bordered">User Name: </p>
    <button onclick="Telegram.WebApp.close()">Close Web App</button>
-->
    <img id="profilePic" class="profile-pic" src="" alt="Profile Picture">
    <p id="userId" class="bordered">User ID: </p>
    <p id="userName" class="bordered">User Name: </p>
    <p id="userUsername" class="bordered">Username: </p>
    <p id="userLanguage" class="bordered">Language: </p>
    <button id="sendDataButton" class="bordered">Send Data to Telegram</button>
    <button onclick="Telegram.WebApp.close()" class="bordered">Close Web App</button>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<br>  
      <br>
<hr>
      <br>
      Exit the Matrix of Central Banking<br>
      The Other Network, TON.<br>
      <br>
      Get a Wallet<br>
      To start using TON,<br> you need to have a wallet. <br>
      It's an app that will hold your TonCoins <br>
      and help you to interact with other apps inside the network.<br>
      <a href="https://ton.org/en/wallets" target="_blank">https://ton.org/en/wallets</a><br>
<br>      
<i></i>Would You Send me a Cent?</i><br>
      <img src="https://raw.githubusercontent.com/ldijkman/async-esp-fs-webserver/master/docs/ino/thermostat_web_flash/Telegram_WebApp/TON.jpg" width="175px"><br>
    <a href="https://ton.org/en/wallets" target="_blank">https://ton.org/en/wallets</a><br>
   <br>
      <br>
No Reason, i Chose https://tonkeeper.com<br>
<hr>
      <br>
      
<textarea style="width: 100%; height: 500px; white-space: pre; overflow-x: auto; resize: both;">
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Why is Telegram restricting me
   did no Evil
      is it that easy to restrict anyone on telegram
          if u do no like someone just report to get him restricted
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   

    telegram webapp miniapp closing after Telegram.WebApp.sendData
        is this normal?
        
    html5 time input does behave different in telegram 
        https://ldijkman.github.io/async-esp-fs-webserver/ino/thermostat_web_flash/Telegram_WebApp/Telegram_WebApp.html
   
    How to inspect Telegram web app?
        Telegram Desktop on Windows and Linuxâ€‹ 
            Go to Settings > Advanced > Experimental settings > Enable webview inspection. 
            Right click in the WebView and choose Inspect.

   
    create a bot 
        https://t.me/BotFather  and ask for /newbot            and get a bot token
   
    get id     
        https://t.me/myidbot and ask for /getid               and get chat_id
   
    new webapp url setting
       https://t.me/BotFather
            /newapp
            /editapp
            /myapps

   arduino ESP8266 telegram webapp miniapp only sends data when launched/opened from bottom keyboard  
        Mini Apps launched from a web_app type keyboard button
        can send data back to the bot in a service message using Telegram.WebApp.sendData.
        This makes it possible for the bot to produce a response without communicating with any external servers.   
        
  times are saved to browser local storage
        if you use the same device / browser it should save the times

 how to send data from arduino ESP8266, bot api, to webapp miniapp web api
       so that i can send status or sensor info from esp8266 to webapp
       do not see how i can do that 

telegram has web storage cloud storage (bit like local storage browser)
       webapp miniapp 
       CloudStorage
           set WebApp.CloudStorage.setItem
           get WebApp.CloudStorage.getItem
       This object controls the cloud storage. Each bot can store up to 1024 items per user in the cloud storage.
       https://core.telegram.org/bots/webapps#cloudstorage
       nice for store time data in cloud 
       so that every browser/device nows the times wich are set
</textarea>


<!--
<script src="https://ldijkman.github.io/async-esp-fs-webserver/foother.js"></script>
Copyright 2023 Dirk Luberth Dijkman Bangert 30 1619GJ Andijk The Netherlands    
The Art of Time Controlled. Visual TimeSlots Schedule.
-->

      
  </center>













<!--       
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyA4sobHNI_CzjwpulbRTF5UXIOhOaCC7D0",
    authDomain: "telegram-8452d.firebaseapp.com",
    projectId: "telegram-8452d",
    storageBucket: "telegram-8452d.appspot.com",
    messagingSenderId: "779791074647",
    appId: "1:779791074647:web:16936fa1849f5e3e7a2a12",
    measurementId: "G-RF3PP7HSZ8"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
-->          
          </body></html>          
